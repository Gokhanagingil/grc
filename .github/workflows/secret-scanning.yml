# =============================================================================
# GRC Platform - Secret Scanning Workflow
# =============================================================================
# Scans repository for accidentally committed secrets using TruffleHog.
# Fails the build only on verified secrets to avoid false positives.
#
# Risk Level: P0 (Critical) - Leaked secrets can lead to immediate compromise
# =============================================================================

name: Secret Scanning

on:
  push:
    branches:
      - main
      - 'devin/**'
  pull_request:
    branches:
      - main
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'

jobs:
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for scanning all commits

      - name: TruffleHog OSS Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified
          # --only-verified: Only report secrets that have been verified as active
          # Note: --fail is already included by the action, don't duplicate it

      - name: Scan Summary
        if: always()
        run: |
          echo "Secret scanning completed."
          echo "Note: Only verified (active) secrets will cause build failure."
          echo "For false positives, add patterns to .trufflehog-ignore or use inline ignores."
