# =============================================================================
# GRC Platform - Secret Scanning Workflow
# =============================================================================
# Scans repository for accidentally committed secrets using TruffleHog.
# Fails the build only on verified secrets to avoid false positives.
#
# Risk Level: P0 (Critical) - Leaked secrets can lead to immediate compromise
#
# Event Handling:
# - pull_request: Scans diff between PR branch and main (default behavior)
# - push to main: Scans commits since the previous HEAD (github.event.before)
# - push to devin/*: Scans diff between branch and main
# - schedule: Scans recent commits (last 50) for daily audit
#
# Root Cause Fix (Jan 2026):
# Previously failed on push to main with "BASE and HEAD commits are the same"
# because after merge, both pointed to the same commit. Now we use
# github.event.before for push events to scan the actual new commits.
# =============================================================================

name: Secret Scanning

on:
  push:
    branches:
      - main
      - 'devin/**'
  pull_request:
    branches:
      - main
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'

jobs:
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for scanning all commits

      - name: Determine scan range
        id: scan-range
        run: |
          echo "=== Determining TruffleHog scan range ==="
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PR: scan from base branch to PR head
            BASE="${{ github.event.pull_request.base.sha }}"
            echo "PR scan: base=$BASE"
            echo "base_ref=$BASE" >> $GITHUB_OUTPUT
            echo "scan_type=pr" >> $GITHUB_OUTPUT
            
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            BEFORE="${{ github.event.before }}"
            
            # Check if this is an initial commit (before is all zeros)
            if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
              echo "Initial commit detected - scanning entire history"
              # For initial commits, scan from the beginning
              FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD 2>/dev/null || echo "")
              if [[ -n "$FIRST_COMMIT" ]]; then
                BASE="$FIRST_COMMIT^" 
              else
                BASE=""
              fi
              echo "base_ref=" >> $GITHUB_OUTPUT
              echo "scan_type=initial" >> $GITHUB_OUTPUT
            else
              echo "Push scan: before=$BEFORE"
              echo "base_ref=$BEFORE" >> $GITHUB_OUTPUT
              echo "scan_type=push" >> $GITHUB_OUTPUT
            fi
            
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            # Scheduled: scan last 50 commits for daily audit
            echo "Scheduled scan: last 50 commits"
            BASE=$(git rev-parse HEAD~50 2>/dev/null || git rev-list --max-parents=0 HEAD)
            echo "base_ref=$BASE" >> $GITHUB_OUTPUT
            echo "scan_type=schedule" >> $GITHUB_OUTPUT
            
          else
            # Fallback: use default branch
            echo "Fallback: using default branch as base"
            echo "base_ref=${{ github.event.repository.default_branch }}" >> $GITHUB_OUTPUT
            echo "scan_type=fallback" >> $GITHUB_OUTPUT
          fi
          
          echo "=== Scan range determined ==="

      - name: TruffleHog OSS Scan
        if: steps.scan-range.outputs.scan_type != 'initial'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ steps.scan-range.outputs.base_ref }}
          head: HEAD
          extra_args: --only-verified
          # --only-verified: Only report secrets that have been verified as active
          # Note: --fail is already included by the action, don't duplicate it

      - name: TruffleHog OSS Scan (Initial/Full)
        if: steps.scan-range.outputs.scan_type == 'initial'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified
          # For initial commits, scan the entire repository without base/head

      - name: Scan Summary
        if: always()
        run: |
          echo "=== Secret Scanning Summary ==="
          echo "Scan type: ${{ steps.scan-range.outputs.scan_type }}"
          echo "Base ref: ${{ steps.scan-range.outputs.base_ref }}"
          echo ""
          echo "Note: Only verified (active) secrets will cause build failure."
          echo ""
          echo "If you encounter false positives:"
          echo "  1. Add patterns to .trufflehogignore (see docs/SECURITY-SECRET-SCAN.md)"
          echo "  2. Each ignore must be justified and documented"
          echo ""
          echo "For more information, see: docs/SECURITY-SECRET-SCAN.md"
