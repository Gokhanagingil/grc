# =============================================================================
# GRC Platform - Credential Pattern Check Workflow
# =============================================================================
# Scans source files for known credential patterns that should not be committed.
# Uses a maintainable config file for pattern definitions.
#
# Risk Level: P1 (High) - Hardcoded credentials can lead to security breaches
# =============================================================================

name: Credential Pattern Check

on:
  push:
    branches:
      - main
      - 'devin/**'
  pull_request:
    branches:
      - main

# Prevent workflow pile-ups: cancel older runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  credential-check:
    name: Check for Credential Patterns
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check for credential patterns
        run: |
          echo "Scanning for credential patterns..."
          
          # Read patterns from config file, skip comments and empty lines
          PATTERNS_FILE=".github/credential-patterns.txt"
          
          if [ ! -f "$PATTERNS_FILE" ]; then
            echo "Warning: Patterns file not found at $PATTERNS_FILE"
            exit 0
          fi
          
          # Files/directories to exclude from scanning
          # Note: grep --exclude matches basenames, --exclude-dir matches directory names
          EXCLUDE_DIRS=(
            ".git"
            ".github"
            "node_modules"
            "dist"
            "build"
            "coverage"
            "test"
            "tests"
            "e2e"
            "playwright-report"
            "test-results"
          )
          
          EXCLUDE_FILES=(
            "*.lock"
            "package-lock.json"
            "*.md"
            "*.spec.ts"
            "*.test.ts"
            "*.e2e-spec.ts"
            # Staging operational scripts that legitimately contain demo credentials
            # These are used for staging environment setup/validation only
            "STAGING_AUDIT_LOGS_DIAGNOSTIC.sh"
            "staging-disk-cleanup-rebuild.sh"
            "STAGING_VALIDATION_SCRIPT.sh"
            "*.env.staging.example"
          )
          
          # Build exclude arguments for grep
          EXCLUDE_ARGS=""
          for dir in "${EXCLUDE_DIRS[@]}"; do
            EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude-dir=$dir"
          done
          for file in "${EXCLUDE_FILES[@]}"; do
            EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude=$file"
          done
          
          FOUND_ISSUES=0
          
          # Read each pattern and search
          while IFS= read -r line || [ -n "$line" ]; do
            # Skip comments and empty lines
            [[ "$line" =~ ^#.*$ ]] && continue
            [[ -z "$line" ]] && continue
            
            # Search for the pattern
            if grep -rn $EXCLUDE_ARGS "$line" . 2>/dev/null; then
              echo "ERROR: Found credential pattern '$line' in source files"
              FOUND_ISSUES=1
            fi
          done < "$PATTERNS_FILE"
          
          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "FAILURE: Credential patterns found in source files."
            echo "Please remove these patterns or add exceptions to the workflow."
            exit 1
          fi
          
          echo "SUCCESS: No credential patterns found in source files."

      - name: Check for TestPassword123! outside allowed locations
        run: |
          echo "Checking for TestPassword123! in non-test files..."
          
          # This pattern is allowed in:
          # - Test files (*.spec.ts, *.test.ts, e2e/*)
          # - CI workflow files
          # - Documentation
          # - Scripts directory (seed, smoke, acceptance scripts need demo credentials)
          # - Config files (configuration.ts, validation.ts define defaults)
          # - Auth controller (documentation comments)
          
          # Search in source files only (excluding allowed locations)
          FOUND=$(grep -rn "TestPassword123!" \
            --include="*.ts" \
            --include="*.tsx" \
            --include="*.js" \
            --include="*.jsx" \
            --exclude="*.spec.ts" \
            --exclude="*.test.ts" \
            --exclude="*.e2e-spec.ts" \
            --exclude="configuration.ts" \
            --exclude="validation.ts" \
            --exclude="auth.controller.ts" \
            --exclude-dir="node_modules" \
            --exclude-dir="dist" \
            --exclude-dir="build" \
            --exclude-dir="e2e" \
            --exclude-dir="test" \
            --exclude-dir="tests" \
            --exclude-dir=".github" \
            --exclude-dir="scripts" \
            . 2>/dev/null || true)
          
          if [ -n "$FOUND" ]; then
            echo "ERROR: Found TestPassword123! in non-test source files:"
            echo "$FOUND"
            echo ""
            echo "This pattern should only appear in test files, scripts, config, and CI configurations."
            exit 1
          fi
          
          echo "SUCCESS: TestPassword123! only found in allowed locations."

      # =========================================================================
      # Check for hardcoded staging IP addresses
      # =========================================================================
      - name: Check for hardcoded staging IP in critical files
        run: |
          echo "Checking for hardcoded staging IP (46.224.99.150) in critical files..."
          
          # These files should NOT contain hardcoded staging IPs:
          # - Frontend source code
          # - Backend source code (except test files)
          # - Docker compose files
          # - CI workflow files (should use secrets)
          
          FOUND_ISSUES=0
          
          # Check frontend source files
          FOUND=$(grep -rn "46\.224\.99\.150" \
            --include="*.ts" \
            --include="*.tsx" \
            --include="*.js" \
            --include="*.jsx" \
            --exclude-dir="node_modules" \
            --exclude-dir="dist" \
            --exclude-dir="build" \
            --exclude-dir="e2e" \
            --exclude="*.spec.ts" \
            --exclude="*.test.ts" \
            frontend/src 2>/dev/null || true)
          
          if [ -n "$FOUND" ]; then
            echo "ERROR: Found hardcoded staging IP in frontend source:"
            echo "$FOUND"
            FOUND_ISSUES=1
          fi
          
          # Check backend source files (excluding test and scripts)
          FOUND=$(grep -rn "46\.224\.99\.150" \
            --include="*.ts" \
            --exclude="*.spec.ts" \
            --exclude="*.test.ts" \
            --exclude="*.e2e-spec.ts" \
            --exclude-dir="node_modules" \
            --exclude-dir="dist" \
            --exclude-dir="test" \
            --exclude-dir="scripts" \
            backend-nest/src 2>/dev/null || true)
          
          if [ -n "$FOUND" ]; then
            echo "ERROR: Found hardcoded staging IP in backend source:"
            echo "$FOUND"
            FOUND_ISSUES=1
          fi
          
          # Check docker-compose files
          FOUND=$(grep -n "46\.224\.99\.150" docker-compose*.yml 2>/dev/null || true)
          
          if [ -n "$FOUND" ]; then
            echo "ERROR: Found hardcoded staging IP in docker-compose files:"
            echo "$FOUND"
            FOUND_ISSUES=1
          fi
          
          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "FAILURE: Hardcoded staging IP found in critical files."
            echo "Use environment variables (STAGING_BASE_URL, STAGING_HOST) instead."
            exit 1
          fi
          
          echo "SUCCESS: No hardcoded staging IP in critical files."

      # =========================================================================
      # Check for hardcoded demo tenant ID in critical files
      # =========================================================================
      - name: Check for hardcoded demo tenant ID in critical files
        run: |
          echo "Checking for hardcoded demo tenant ID in critical files..."
          
          # The demo tenant ID (00000000-0000-0000-0000-000000000001) should only appear in:
          # - Test files
          # - Seed scripts
          # - Documentation
          # NOT in:
          # - Frontend source code
          # - Backend controllers/services (except test files)
          
          FOUND_ISSUES=0
          
          # Check frontend source files
          FOUND=$(grep -rn "00000000-0000-0000-0000-000000000001" \
            --include="*.ts" \
            --include="*.tsx" \
            --exclude="*.spec.ts" \
            --exclude="*.test.ts" \
            --exclude-dir="node_modules" \
            --exclude-dir="dist" \
            --exclude-dir="e2e" \
            frontend/src 2>/dev/null || true)
          
          if [ -n "$FOUND" ]; then
            echo "ERROR: Found hardcoded demo tenant ID in frontend source:"
            echo "$FOUND"
            FOUND_ISSUES=1
          fi
          
          # Check backend controllers and services (excluding test and scripts)
          FOUND=$(grep -rn "00000000-0000-0000-0000-000000000001" \
            --include="*.controller.ts" \
            --include="*.service.ts" \
            --exclude="*.spec.ts" \
            --exclude-dir="node_modules" \
            --exclude-dir="dist" \
            --exclude-dir="test" \
            backend-nest/src 2>/dev/null || true)
          
          if [ -n "$FOUND" ]; then
            echo "ERROR: Found hardcoded demo tenant ID in backend controllers/services:"
            echo "$FOUND"
            FOUND_ISSUES=1
          fi
          
          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "FAILURE: Hardcoded demo tenant ID found in critical files."
            echo "Use environment variables (DEMO_TENANT_ID) instead."
            exit 1
          fi
          
          echo "SUCCESS: No hardcoded demo tenant ID in critical files."
