# =============================================================================
# GRC Platform - Frontend CI Workflow
# =============================================================================
# Triggers:
#   - Push to main branch affecting frontend/**
#   - Push to devin/** branches affecting frontend/**
#   - Pull requests to main affecting frontend/**
#
# Jobs:
#   1. lint           - ESLint code quality checks
#   2. security-audit - npm audit for vulnerability scanning
#   3. build          - Production build verification
#   4. test           - Jest unit tests
#
# Environment:
#   - Node.js 20.x
# =============================================================================

name: Frontend CI

on:
  push:
    branches:
      - main
      - 'devin/**'
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  WORKING_DIRECTORY: ./frontend

jobs:
  # ---------------------------------------------------------------------------
  # Lint - Code Quality Checks
  # ---------------------------------------------------------------------------
  lint:
    name: Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npx eslint src/ --ext .ts,.tsx

  # ---------------------------------------------------------------------------
  # Security Audit - Vulnerability Scanning
  # ---------------------------------------------------------------------------
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level=high
        # Security audit is enforced - CI will fail on high/critical vulnerabilities

  # ---------------------------------------------------------------------------
  # Build - Production Build Verification
  # ---------------------------------------------------------------------------
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
        env:
          CI: true
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build
          path: frontend/build
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Test - Jest Unit Tests
  # ---------------------------------------------------------------------------
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm test -- --coverage --watchAll=false --passWithNoTests
        env:
          CI: true

